#!/bin/bash

# PID to profile.
PID=
TIME=60
while getopts ":p:t:x" opt; do
  case $opt in
    p) PID="$OPTARG" ;;
    t) TIME="$OPTARG" ;;
    x) set -x ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND - 1))

CMD=(perf record
     -g
     --call-graph dwarf
     -F 101
    )
if [ -z "$PID" ]; then
  echo "Capturing data for all processes..."
  CMD+=(-a)
else
  CMD+=(-p "$PID")
fi

"${CMD[@]}" "$@" -- sleep "$TIME"

script() {
  if [ -z "$1" ]; then
    perf script 2>/dev/null | stackcollapse-perf.pl --all | grep bitcoin
  else
    perf script 2>/dev/null | stackcollapse-perf.pl --all
  fi
}

script "$PID" > /tmp/collapse.txt
